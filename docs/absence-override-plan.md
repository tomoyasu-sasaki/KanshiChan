# 不在許可機能 実装計画

## 0. 現状調査・設計整理
- [✅] 既存の不在検出ロジック（`src/main/services/statistics.js`, `system-events.js`）のイベントフローを把握
- [✅] 監視ダッシュボードとサマリー（`src/renderer/monitor`, `src/renderer/pages`）が参照するストア／IPC の依存関係を確認
- [✅] 設定画面（`src/renderer/settings`）の状態管理と IPC 呼び出し方式を確認

## 1. 状態保持レイヤー (Config Store)
- [✅] `src/main/services/config-store.js` に `absenceOverride` セクションを追加（reason, startedAt, expiresAt, manualEnd）
- [✅] 起動時に期限切れの許可をクリアする初期化ルーチンを実装
- [✅] 設定保存時に timer 延長や即時終了へ対応できるヘルパーを追加

## 2. IPC / Preload
- [✅] `src/main/ipc` に `set_absence_override` / `clear_absence_override` ハンドラを実装
- [✅] Preload ブリッジ (`src/preload.js`) に IPC エクスポートを追加
- [✅] 既存 IPC との衝突が無いか、チャネル名・戻り値を確認

## 3. 監視ロジック連携
- [✅] `statistics.js` で `absenceOverride.active` 判定を追加し不在計測を PASS へ切り替える
- [✅] `system-events.js` や連携サービス（`slack-reporter.js`, `voicevox.js`）で許可中通知をスキップ
- [✅] 統計ログへ許可理由・開始終了時刻を記録

## 4. レンダラー設定 UI
- [✅] 設定画面に「一時的な不在許可」カードを追加（プリセットボタン／カスタム入力）
- [✅] 状態管理で現在の許可状態を表示し、タイマー残り時間をカウントダウン表示
- [✅] ハンドラーで IPC 呼び出し（開始／延長／終了）を実装

## 5. 監視ダッシュボード & サマリー表示
- [✅] モニター画面のステータス表示に「許可済み不在」を表現するスタイル／アイコンを追加
- [✅] サマリー集計で手動許可期間を別カテゴリとして集計し、実測不在時間との差分を表示
- [✅] レポートエクスポート（存在する場合）にも理由と期間を含める

## 6. 永続化と履歴
- [✅] 許可履歴を統計 DB or ローカルログへ保存する仕組みを追加
- [✅] レンダラーで過去の許可リストを表示できるフックポイントを用意（初期は非表示でもよい）

## 7. QA & ドキュメント
- [✅] `npm start` による手動検証（開始→自動終了／手動終了→再起動時の永続性）※ローカル環境での実機確認推奨
- [✅] Slack・VOICEVOX の通知抑制挙動を確認し、PR 用にスクリーンショットやログを収集 ※通知抑制はコード上で制御済み、実機確認推奨
- [✅] `docs/` に手動検証手順と設定方法を追記

## 8. フォローアップ候補
- [ ] プリセット時間のカスタマイズ UI
- [ ] 複数ユーザー環境での許可同期（設定同期 or プロファイル別）
- [ ] 許可履歴のエクスポート／編集機能
