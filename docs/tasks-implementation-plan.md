# タスク管理機能 実装計画

## 📋 プロジェクト概要

このドキュメントは、Kanshichan に実装済みのタスク管理機能に対する未実装項目と改善計画をまとめたものです。
現在の実装状況を踏まえ、今後の開発タスクをチェックリスト形式で管理します。

**最終更新日**: 2025-01-02
**対象ブランチ**: `feature/tasks-management`
**関連コミット**: `445239a` (セキュリティ・データ整合性の強化)

---

## ✅ 実装済み機能

以下の機能は既に実装済みです:

### バックエンド (メインプロセス)
- [x] SQLite データベーススキーマ (`tasks` テーブル)
  - [x] 基本フィールド (id, title, description, priority, status)
  - [x] 日付フィールド (start_date, end_date)
  - [x] スケジュール紐付け (schedule_id)
  - [x] タイムスタンプ (created_at, updated_at)
  - [x] インデックス (status, priority, period)
  - [x] 外部キー制約の準備 (PRAGMA foreign_keys ON)
- [x] タスクサービス (`src/main/services/tasks.js`)
  - [x] CRUD 操作 (createTask, updateTask, deleteTask, listTasks)
  - [x] トランザクション対応
  - [x] 入力バリデーション
  - [x] 日付パーサー (start/end date)
  - [x] フィルタリング (status, priority, scheduleId, activeAt)
- [x] IPC ハンドラ (`src/main/ipc/register-handlers.js`)
  - [x] tasks-create, tasks-update, tasks-delete, tasks-list
  - [x] ペイロード検証
  - [x] エラーメッセージのサニタイズ
- [x] LLM 統合 (`src/main/services/llm.js`)
  - [x] 音声コマンドからタスク操作を抽出 (inferTaskCommands)
  - [x] プロンプトインジェクション対策
  - [x] 相対日付解析 (今日/明日/今週/来週)
  - [x] JSON Schema バリデーション
- [x] オーディオプロファイル設定 (`src/constants/audioProfiles.js`)
  - [x] tasks プロファイル定義

### フロントエンド (レンダラープロセス)
- [x] UI コンポーネント (`src/pages/index.html`)
  - [x] タスクダイアログ
  - [x] タスクフォーム (タイトル/説明/優先度/ステータス/日付/スケジュール紐付け)
  - [x] タスク一覧表示
  - [x] フィルタ (期間中のみ/完了を隠す)
  - [x] 音声操作セクション
- [x] タスクモジュール (`src/renderer/tasks.js`)
  - [x] CRUD 操作 (フォーム送信、編集、削除)
  - [x] リスト表示 (優先度/ステータス別バッジ)
  - [x] フィルタリング機能
  - [x] スケジュール連携 (プルダウン)
  - [x] 音声コマンド統合 (AudioInputControl)
  - [x] 毎朝 9 時の自動読み上げ (期間中タスク)
- [x] Preload API (`src/preload.js`)
  - [x] tasksCreate, tasksUpdate, tasksDelete, tasksList

### セキュリティ・品質
- [x] プロンプトインジェクション対策
- [x] IPC ペイロード検証
- [x] エラーメッセージサニタイズ
- [x] トランザクション対応
- [x] 存在チェック (update/delete)
- [x] 日付バリデーション

---

## 🚧 未実装項目・改善計画

### Phase 1: コア機能の補完 (優先度: 高)

#### 1.1 データベース改善
- [x] **スケジュールテーブルの移行**
  - [x] localStorage から SQLite への移行
  - [x] schedules テーブル作成
  - [x] 外部キー制約の有効化 (`tasks.schedule_id REFERENCES schedules(id)`)
  - [x] マイグレーションスクリプト作成
  - [x] スケジュール関連 IPC ハンドラの更新

- [x] **データベースマイグレーションのリファクタリング**
  - [x] 現在の深いコールバックネスト (300+ 行) を async/await に書き換え
  - [x] マイグレーションを個別ファイルに分離 (`src/main/db/migrations/`)
  - [x] バージョン管理システムの導入 (例: `db_version` テーブル)
  - [x] ロールバック機能の実装

#### 1.2 タスク機能の拡張
- [x] **サブタスク機能**
  - [x] `parent_task_id` カラム追加
  - [x] 階層構造の表示 UI
  - [x] サブタスク完了時の親タスク進捗自動更新

- [x] **タスクタグ/ラベル機能**
  - [x] `task_tags` テーブル作成 (多対多リレーション)
  - [x] タグによるフィルタリング
  - [x] タグ別の色分け表示

- [x] **タスクの並び替え**
  - [x] ドラッグ&ドロップによる優先順位変更
  - [x] `display_order` カラム追加
  - [x] カスタムソート順の保存

- [x] **繰り返しタスク**
  - [x] `repeat_config` (JSON) カラム追加
  - [x] 繰り返しパターン設定 UI (日次/週次/月次)
  - [x] 自動タスク生成ロジック

#### 1.3 音声機能の強化
- [x] **音声コマンドの拡張**
  - [x] サブタスク操作 (「〇〇のサブタスクを追加」)
  - [x] タグ操作 (「タグを急ぎに変更」)
  - [x] 複数タスク一括操作 (「完了したタスクを全部削除」)
  - [x] 検索コマンド (「来週のタスクを教えて」)

- [x] **読み上げ機能の改善**
  - [x] カスタマイズ可能な読み上げ時刻
  - [x] 読み上げ内容のフィルタリング設定
  - [x] 優先度別の読み上げスタイル変更

---

### Phase 2: UI/UX の改善 (優先度: 中)

#### 2.1 タスク一覧の機能強化
- [ ] **高度なフィルタリング**
  - [ ] 複数条件の組み合わせ (AND/OR)
  - [ ] 日付範囲指定 (「今週」「今月」「今四半期」)
  - [ ] カスタムフィルタの保存

- [ ] **ソート機能**
  - [ ] 複数カラムによるソート
  - [ ] カスタムソート順の保存
  - [ ] グループ化表示 (優先度別/ステータス別)

- [ ] **ビュー切り替え**
  - [ ] リストビュー (現在実装中)
  - [ ] カードビュー
  - [ ] カンバンボード (todo/in_progress/done)
  - [ ] カレンダービュー (Gantt チャート風)

#### 2.2 タスク詳細画面
- [ ] **詳細情報の表示**
  - [ ] 作成日時・更新日時の表示
  - [ ] 履歴トラッキング (変更ログ)
  - [ ] 添付ファイル機能

- [ ] **リッチテキストエディタ**
  - [ ] Markdown サポート
  - [ ] チェックリスト埋め込み
  - [ ] コードブロックのシンタックスハイライト

#### 2.3 通知・リマインダー
- [ ] **期限通知**
  - [ ] タスク開始日の事前通知
  - [ ] 期限切れタスクの警告
  - [ ] カスタムリマインダー設定

- [ ] **デスクトップ通知連携**
  - [ ] タスク完了時の通知
  - [ ] 優先度高タスクの定期リマインダー

---

### Phase 3: 統合・連携機能 (優先度: 中)

#### 3.1 スケジュール連携の強化
- [ ] **双方向リンク**
  - [ ] スケジュール詳細画面から紐付きタスク一覧表示
  - [ ] タスク完了時にスケジュールステータスを自動更新
  - [ ] スケジュール時刻にタスクリマインダー

- [ ] **自動タスク生成**
  - [ ] スケジュール作成時に関連タスクを自動生成
  - [ ] 定例会議からの定型タスク生成

#### 3.2 ダッシュボード統合
- [ ] **タスク統計の可視化**
  - [ ] 完了率グラフ (日次/週次/月次)
  - [ ] 優先度別分布
  - [ ] ステータス別カウント
  - [ ] 平均完了時間

- [ ] **アクティビティタイムライン**
  - [ ] タスク作成/更新/完了の時系列表示
  - [ ] 検知ログ・システムイベントとの統合表示

#### 3.3 Slack 連携
- [ ] **Slack レポートへのタスク情報追加**
  - [ ] 当日完了タスク数
  - [ ] 期限切れタスク一覧
  - [ ] 今日開始予定のタスク

- [ ] **Slack からのタスク操作**
  - [ ] Slack メッセージからタスク作成 (Slash コマンド)
  - [ ] タスク完了報告を Slack に投稿

---

### Phase 4: テスト・品質保証 (優先度: 高)

#### 4.1 ユニットテスト
- [ ] **バックエンドテスト**
  - [ ] `tasks.js` の全関数のテスト
  - [ ] `llm.js` の日付パーサーテスト
  - [ ] IPC ハンドラのバリデーションテスト
  - [ ] エッジケース (不正な入力、NULL 値、境界値)

- [ ] **フロントエンドテスト**
  - [ ] `tasks.js` (レンダラー) のテスト
  - [ ] フォームバリデーションのテスト
  - [ ] フィルタリングロジックのテスト

#### 4.2 統合テスト
- [ ] **E2E テスト**
  - [ ] タスク作成から完了までのフロー
  - [ ] 音声コマンドによるタスク操作
  - [ ] スケジュール連携のテスト

- [ ] **パフォーマンステスト**
  - [ ] 1000 件以上のタスク読み込み速度
  - [ ] フィルタリング・ソートのレスポンス時間
  - [ ] データベースクエリの最適化

#### 4.3 セキュリティテスト
- [ ] **脆弱性テスト**
  - [ ] SQL インジェクション対策の検証
  - [ ] プロンプトインジェクション対策の検証
  - [ ] XSS 対策の検証 (HTML エスケープ)

---

### Phase 5: ドキュメント整備 (優先度: 中)

#### 5.1 ユーザードキュメント
- [ ] **機能説明書**
  - [ ] タスク管理機能の使い方
  - [ ] 音声コマンド一覧
  - [ ] スケジュール連携の活用方法

- [ ] **チュートリアル**
  - [ ] はじめてのタスク作成
  - [ ] 音声でタスクを操作する
  - [ ] タスク統計の見方

#### 5.2 開発者ドキュメント
- [ ] **API ドキュメント**
  - [ ] IPC ハンドラの仕様
  - [ ] データベーススキーマ
  - [ ] タスクサービスの関数リファレンス

- [ ] **アーキテクチャドキュメント**
  - [ ] タスク管理機能の設計図
  - [ ] データフロー図
  - [ ] LLM 統合の仕組み

---

## 📊 優先度マトリクス

| フェーズ | 項目 | 優先度 | 工数見積 | 依存関係 |
|---------|------|--------|---------|---------|
| Phase 1.1 | スケジュールテーブル移行 | 高 | 大 (3-5 日) | なし |
| Phase 1.1 | DB マイグレーションリファクタ | 中 | 大 (3-5 日) | なし |
| Phase 1.2 | サブタスク機能 | 中 | 中 (2-3 日) | なし |
| Phase 1.2 | タグ/ラベル機能 | 中 | 中 (2-3 日) | なし |
| Phase 1.2 | 並び替え機能 | 低 | 小 (1 日) | なし |
| Phase 1.2 | 繰り返しタスク | 中 | 大 (3-4 日) | なし |
| Phase 1.3 | 音声コマンド拡張 | 中 | 中 (2-3 日) | Phase 1.2 |
| Phase 2.1 | 高度なフィルタリング | 中 | 中 (2 日) | なし |
| Phase 2.2 | タスク詳細画面 | 低 | 中 (2 日) | なし |
| Phase 2.3 | 通知・リマインダー | 高 | 中 (2-3 日) | なし |
| Phase 3.1 | スケジュール連携強化 | 高 | 中 (2 日) | Phase 1.1 |
| Phase 3.2 | ダッシュボード統合 | 中 | 中 (2-3 日) | なし |
| Phase 3.3 | Slack 連携 | 低 | 中 (2 日) | なし |
| Phase 4 | テスト整備 | 高 | 大 (5-7 日) | 全フェーズ |
| Phase 5 | ドキュメント整備 | 中 | 中 (3-4 日) | 全フェーズ |

**凡例**:
- 優先度: 高 > 中 > 低
- 工数見積: 小 (< 1 日) / 中 (1-3 日) / 大 (3+ 日)

---

## 🎯 推奨実装順序

### スプリント 1 (1-2 週間)
1. **Phase 1.1**: スケジュールテーブル移行
2. **Phase 2.3**: 通知・リマインダー基本機能
3. **Phase 4.1**: 基本的なユニットテスト

### スプリント 2 (1-2 週間)
1. **Phase 1.2**: サブタスク + タグ機能
2. **Phase 3.1**: スケジュール連携強化
3. **Phase 4.2**: 統合テスト

### スプリント 3 (1-2 週間)
1. **Phase 1.3**: 音声コマンド拡張
2. **Phase 2.1**: 高度なフィルタリング
3. **Phase 3.2**: ダッシュボード統合

### スプリント 4 (1 週間)
1. **Phase 1.1**: DB マイグレーションリファクタ (技術的負債解消)
2. **Phase 5**: ドキュメント整備
3. **Phase 4.3**: セキュリティテスト

---

## 🐛 既知の問題・技術的負債

### 高優先度
1. **データベースマイグレーションの複雑性**
   - 現状: 深いコールバックネスト (300+ 行)
   - 影響: 保守性低下、エラーハンドリングの困難さ
   - 対策: Phase 1.1 で async/await リファクタリング

2. **スケジュールデータの永続化**
   - 現状: localStorage のみ (データ損失リスク)
   - 影響: スケジュール連携の不安定性
   - 対策: Phase 1.1 でデータベース移行

### 中優先度
3. **LLM の相対日付解析の限界**
   - 現状: 「今週」「来週」などの限定的なサポート
   - 影響: 複雑な日付表現への対応不足
   - 対策: Phase 1.3 で解析ロジック拡張

4. **タスク一覧のパフォーマンス**
   - 現状: 全タスクをメモリに読み込み
   - 影響: タスク数増加時のレスポンス低下
   - 対策: Phase 4.2 でページネーション実装

### 低優先度
5. **UI のレスポンシブデザイン不足**
   - 現状: デスクトップ専用 UI
   - 影響: 画面サイズによっては見づらい
   - 対策: Phase 2 で CSS 改善

---

## 📝 メモ・備考

- **音声機能の依存性**: Whisper + LLM モデルが必須。セットアップ未完了の環境では音声操作が無効化される。
- **スケジュール連携**: 現在は localStorage ベースのため、タスクとスケジュールのデータ整合性に注意。
- **外部キー制約**: PRAGMA foreign_keys ON 済みだが、schedules テーブル未実装のため未適用。
- **テストカバレッジ**: 現在 0%。Phase 4 で最低 70% を目標。

---

## 🔗 関連リソース

- [メインプロジェクト README](../README.md)
- [データベーススキーマ](../src/main/db/index.js)
- [タスクサービス実装](../src/main/services/tasks.js)
- [LLM プロンプト定義](../src/constants/llm-prompts.js)
- [フロントエンド実装](../src/renderer/tasks.js)
- [セキュリティ修正コミット](https://github.com/tomoyasu-sasaki/kanshichan/commit/445239a)

---

**このドキュメントは定期的に更新されます。実装完了時はチェックボックスにチェックを入れてください。**
