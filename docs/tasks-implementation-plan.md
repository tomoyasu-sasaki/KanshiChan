# タスク管理機能 実装計画

## 📋 プロジェクト概要

このドキュメントは、Kanshichan に実装済みのタスク管理機能に対する未実装項目と改善計画をまとめたものです。
現在の実装状況を踏まえ、今後の開発タスクをチェックリスト形式で管理します。

**最終更新日**: 2025-01-02
**対象ブランチ**: `feature/tasks-management`
**関連コミット**: `445239a` (セキュリティ・データ整合性の強化)

---

## ✅ 実装済み機能

以下の機能は既に実装済みです:

### バックエンド (メインプロセス)
- [x] SQLite データベーススキーマ (`tasks` テーブル)
  - [x] 基本フィールド (id, title, description, priority, status)
  - [x] 日付フィールド (start_date, end_date)
  - [x] スケジュール紐付け (schedule_id)
  - [x] タイムスタンプ (created_at, updated_at)
  - [x] インデックス (status, priority, period)
  - [x] 外部キー制約の準備 (PRAGMA foreign_keys ON)
- [x] タスクサービス (`src/main/services/tasks.js`)
  - [x] CRUD 操作 (createTask, updateTask, deleteTask, listTasks)
  - [x] トランザクション対応
  - [x] 入力バリデーション
  - [x] 日付パーサー (start/end date)
  - [x] フィルタリング (status, priority, scheduleId, activeAt)
- [x] IPC ハンドラ (`src/main/ipc/register-handlers.js`)
  - [x] tasks-create, tasks-update, tasks-delete, tasks-list
  - [x] ペイロード検証
  - [x] エラーメッセージのサニタイズ
- [x] LLM 統合 (`src/main/services/llm.js`)
  - [x] 音声コマンドからタスク操作を抽出 (inferTaskCommands)
  - [x] プロンプトインジェクション対策
  - [x] 相対日付解析 (今日/明日/今週/来週)
  - [x] JSON Schema バリデーション
- [x] オーディオプロファイル設定 (`src/constants/audioProfiles.js`)
  - [x] tasks プロファイル定義

### フロントエンド (レンダラープロセス)
- [x] UI コンポーネント (`src/pages/index.html`)
  - [x] タスクダイアログ
  - [x] タスクフォーム (タイトル/説明/優先度/ステータス/日付/スケジュール紐付け)
  - [x] タスク一覧表示
  - [x] フィルタ (期間中のみ/完了を隠す)
  - [x] 音声操作セクション
- [x] タスクモジュール (`src/renderer/tasks.js`)
  - [x] CRUD 操作 (フォーム送信、編集、削除)
  - [x] リスト表示 (優先度/ステータス別バッジ)
  - [x] フィルタリング機能
  - [x] スケジュール連携 (プルダウン)
  - [x] 音声コマンド統合 (AudioInputControl)
  - [x] 毎朝 9 時の自動読み上げ (期間中タスク)
- [x] Preload API (`src/preload.js`)
  - [x] tasksCreate, tasksUpdate, tasksDelete, tasksList

### セキュリティ・品質
- [x] プロンプトインジェクション対策
- [x] IPC ペイロード検証
- [x] エラーメッセージサニタイズ
- [x] トランザクション対応
- [x] 存在チェック (update/delete)
- [x] 日付バリデーション

---

## 🚧 未実装項目・改善計画

### Phase 1: コア機能の補完 (優先度: 高)

#### 1.1 データベース改善
- [x] **スケジュールテーブルの移行**
  - [x] localStorage から SQLite への移行
  - [x] schedules テーブル作成
  - [x] 外部キー制約の有効化 (`tasks.schedule_id REFERENCES schedules(id)`)
  - [x] マイグレーションスクリプト作成
  - [x] スケジュール関連 IPC ハンドラの更新

- [x] **データベースマイグレーションのリファクタリング**
  - [x] 現在の深いコールバックネスト (300+ 行) を async/await に書き換え
  - [x] マイグレーションを個別ファイルに分離 (`src/main/db/migrations/`)
  - [x] バージョン管理システムの導入 (例: `db_version` テーブル)
  - [x] ロールバック機能の実装

#### 1.2 タスク機能の拡張
- [x] **サブタスク機能**
  - [x] `parent_task_id` カラム追加
  - [x] 階層構造の表示 UI
  - [x] サブタスク完了時の親タスク進捗自動更新

- [x] **タスクタグ/ラベル機能**
  - [x] `task_tags` テーブル作成 (多対多リレーション)
  - [x] タグによるフィルタリング
  - [x] タグ別の色分け表示

- [x] **タスクの並び替え**
  - [x] ドラッグ&ドロップによる優先順位変更
  - [x] `display_order` カラム追加
  - [x] カスタムソート順の保存

- [x] **繰り返しタスク**
  - [x] `repeat_config` (JSON) カラム追加
  - [x] 繰り返しパターン設定 UI (日次/週次/月次)
  - [x] 自動タスク生成ロジック

#### 1.3 音声機能の強化
- [x] **音声コマンドの拡張**
  - [x] サブタスク操作 (「〇〇のサブタスクを追加」)
  - [x] タグ操作 (「タグを急ぎに変更」)
  - [x] 複数タスク一括操作 (「完了したタスクを全部削除」)
  - [x] 検索コマンド (「来週のタスクを教えて」)

- [x] **読み上げ機能の改善**
  - [x] カスタマイズ可能な読み上げ時刻
  - [x] 読み上げ内容のフィルタリング設定
  - [x] 優先度別の読み上げスタイル変更

---

### Phase 2: UI/UX の改善 (優先度: 中)

#### 2.1 タスク一覧の機能強化
- [x] **高度なフィルタリング**
  - [x] 複数条件の組み合わせ (AND/OR)
  - [x] 日付範囲指定 (「今週」「今月」「今四半期」)
  - [x] カスタムフィルタの保存

- [x] **ソート機能**
  - [x] 複数カラムによるソート
  - [x] カスタムソート順の保存
  - [x] グループ化表示 (優先度別/ステータス別)

- [x] **ビュー切り替え**
  - [x] リストビュー (現在実装中)
  - [x] カードビュー
  - [x] カンバンボード (todo/in_progress/done)
  - [ ] カレンダービュー (Gantt チャート風) - 将来実装

#### 2.2 通知・リマインダー
- [x] **期限通知**
  - [x] タスク開始日の事前通知
  - [x] 期限切れタスクの警告
  - [x] カスタムリマインダー設定

- [x] **デスクトップ通知連携**
  - [x] 優先度高タスクの定期リマインダー
  - [x] タスク完了時の通知

---

### Phase 3: 統合・連携機能 (優先度: 中)

#### 3.1 スケジュール連携の強化
- [x] **双方向リンク**
  - [x] スケジュール詳細画面から紐付きタスク一覧表示
  - [ ] タスク完了時にスケジュールステータスを自動更新
  - [ ] スケジュール時刻にタスクリマインダー

- [ ] **自動タスク生成**
  - [ ] スケジュール作成時に関連タスクを自動生成
  - [ ] 定例会議からの定型タスク生成

#### 3.2 ダッシュボード統合
- [x] **タスク統計の可視化**
  - [x] 完了率グラフ (日次/週次/月次) - バックエンドAPI + フロントエンドUI実装済み
  - [x] 優先度別分布 - バックエンドAPI + フロントエンドUI実装済み
  - [x] ステータス別カウント - バックエンドAPI + フロントエンドUI実装済み
  - [x] 平均完了時間 - バックエンドAPI + フロントエンドUI実装済み
  - [x] KPIカード表示（総タスク数、完了率、ステータス別、平均完了日数）
  - [x] ステータス別・優先度別のバーチャート表示

- [ ] **アクティビティタイムライン**
  - [ ] タスク作成/更新/完了の時系列表示
  - [ ] 検知ログ・システムイベントとの統合表示

#### 3.3 Slack 連携
- [x] **Slack レポートへのタスク情報追加**
  - [x] 当日完了タスク数
  - [x] 期限切れタスク一覧
  - [x] 今日開始予定のタスク
  - [x] タスク統計情報（完了率、ステータス別内訳、平均完了日数）

- [ ] **Slack からのタスク操作**
  - [ ] Slack メッセージからタスク作成 (Slash コマンド) - 将来実装
  - [ ] タスク完了報告を Slack に投稿 - 将来実装

---

## 📝 メモ・備考

- **音声機能の依存性**: Whisper + LLM モデルが必須。セットアップ未完了の環境では音声操作が無効化される。
- **スケジュール連携**: 現在は localStorage ベースのため、タスクとスケジュールのデータ整合性に注意。
- **外部キー制約**: PRAGMA foreign_keys ON 済みだが、schedules テーブル未実装のため未適用。
- **テストカバレッジ**: 現在 0%。Phase 4 で最低 70% を目標。

---

## 🔗 関連リソース

- [メインプロジェクト README](../README.md)
- [データベーススキーマ](../src/main/db/index.js)
- [タスクサービス実装](../src/main/services/tasks.js)
- [LLM プロンプト定義](../src/constants/llm-prompts.js)
- [フロントエンド実装](../src/renderer/tasks.js)
- [セキュリティ修正コミット](https://github.com/tomoyasu-sasaki/kanshichan/commit/445239a)

---

**このドキュメントは定期的に更新されます。実装完了時はチェックボックスにチェックを入れてください。**
