<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanchichan - 監視</title>
  <link rel="stylesheet" href="../styles/style.css">
</head>
<body class="monitor-view">
  <!-- メイン監視画面 -->
  <div class="monitor-container">
    <!-- カメラフィード -->
    <div class="camera-feed">
      <video id="videoElement" autoplay playsinline></video>
      <canvas id="canvasElement"></canvas>
      
      <!-- ステータス表示（オーバーレイ） -->
      <div class="status-overlay">
        <div class="status-badge" id="phoneStatusBadge">
          <span class="icon">📱</span>
          <span id="phoneTimer">0:00</span>
        </div>
        <div class="status-badge" id="presenceStatusBadge">
          <span class="icon">👤</span>
          <span id="absenceTimer">0:00</span>
        </div>
      </div>

      <!-- 監視状態インジケーター -->
      <div class="monitor-indicator" id="monitorIndicator">
        <div class="recording-dot"></div>
        <span>監視中</span>
      </div>
    </div>

    <!-- のツールバー -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="app-info">
          <h1>📹 Kanchichan</h1>
          <span class="time-display" id="currentTime">--:--</span>
        </div>
      </div>

      <div class="toolbar-center">
        <button class="tool-button" id="scheduleBtn" title="スケジュール">
          <span class="icon">📅</span>
          <span class="label">スケジュール</span>
        </button>
        <button class="tool-button" id="settingsBtn" title="設定">
          <span class="icon">⚙️</span>
          <span class="label">設定</span>
        </button>
        <button class="tool-button" id="logsBtn" title="ログ">
          <span class="icon">📋</span>
          <span class="label">ログ</span>
        </button>
        <button class="tool-button" id="chatBtn" title="音声チャット">
          <span class="icon">💬</span>
          <span class="label">チャット</span>
        </button>
        <button class="tool-button" id="dashboardBtn" title="検知ダッシュボード">
          <span class="icon">📊</span>
          <span class="label">ダッシュボード</span>
        </button>
      </div>

      <div class="toolbar-right">
        <button class="tool-button danger" id="exitBtn" title="終了">
          <span class="icon">❌</span>
        </button>
      </div>
    </div>
  </div>

  <!-- スケジュールダイアログ -->
  <div class="dialog" id="scheduleDialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h2>📅 スケジュール管理</h2>
        <button class="close-btn" data-dialog="scheduleDialog">×</button>
      </div>

      <div class="dialog-body">
        <div class="schedule-form-container">
          <h3>スケジュール追加</h3>

          <section class="schedule-voice-section">
            <h4>音声で追加</h4>
            <p class="schedule-voice-helper">録音後に表示される候補をフォームへ取り込み、必要に応じて編集してください。</p>
            <div id="scheduleVoiceControl"></div>
            <div id="scheduleVoiceResults" class="schedule-voice-results"></div>
          </section>

          <!-- タブ切り替え -->
          <div class="schedule-input-tabs">
            <button class="tab-button active" data-tab="single">1件ずつ</button>
            <button class="tab-button" data-tab="bulk">一括入力</button>
          </div>

          <!-- 1件ずつフォーム -->
          <form id="scheduleForm" class="tab-content active" data-tab-content="single">
            <div class="form-group">
              <label for="title">タイトル</label>
              <input type="text" id="title" required>
            </div>

            <div class="form-group">
              <label for="date">日付</label>
              <input type="date" id="date" required>
            </div>

            <div class="form-group">
              <label for="time">時刻</label>
              <input type="time" id="time" required>
            </div>

            <div class="form-group">
              <label for="description">説明</label>
              <textarea id="description" rows="3"></textarea>
            </div>

            <div class="form-group repeat-settings">
              <label>繰り返し設定</label>
              <div class="repeat-presets">
                <button type="button" class="repeat-preset" data-repeat="none">繰り返しなし</button>
                <button type="button" class="repeat-preset" data-repeat="weekdays">平日</button>
                <button type="button" class="repeat-preset" data-repeat="everyday">毎日</button>
              </div>
              <div class="repeat-weekdays" id="repeatWeekdayContainer">
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="1">
                  月
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="2">
                  火
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="3">
                  水
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="4">
                  木
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="5">
                  金
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="6">
                  土
                </label>
                <label class="repeat-day">
                  <input type="checkbox" class="repeat-day-checkbox" value="0">
                  日
                </label>
              </div>
              <div class="repeat-summary" id="repeatSummary">繰り返しなし</div>
            </div>

            <div class="schedule-form-actions">
              <button type="submit" class="btn-primary" id="scheduleSubmitBtn">追加</button>
              <button type="button" class="btn-secondary" id="scheduleCancelEditBtn" hidden>キャンセル</button>
            </div>
            <p class="schedule-edit-hint" id="scheduleEditHint" hidden>編集中: 内容を更新したら「更新」を押すか、キャンセルで編集を終了します。</p>
          </form>

          <!-- 一括入力フォーム -->
          <div class="tab-content" data-tab-content="bulk">
            <div class="form-group">
              <label for="bulkInput">
                一括入力（1行に1件: 時刻 タイトル | 繰り返し）
                <span class="input-hint">例: 10:00 朝会 | mon,wed</span>
              </label>
              <textarea id="bulkInput" rows="8" placeholder="10:00 朝会 | mon,wed&#10;11:30 ランチ&#10;13:00 レビュー会議 | weekday&#10;15:00 コーディング時間"></textarea>
            </div>
            <button type="button" id="bulkAddBtn" class="btn-primary">一括追加</button>
      </div>
    </div>

    <div class="schedule-tools">
      <div class="schedule-tools-header">
        <h4>CSV インポート / エクスポート</h4>
        <p>列: title, date, time, description, repeat_type, repeat_days</p>
      </div>
      <div class="schedule-tools-actions">
        <button type="button" class="btn-secondary" id="scheduleCsvImportBtn">CSVインポート</button>
        <button type="button" class="btn-secondary" id="scheduleCsvExportBtn">CSVエクスポート</button>
      </div>
      <input type="file" id="scheduleCsvInput" accept=".csv" hidden>
    </div>

    <div class="schedule-list-container">
      <h3>スケジュール一覧</h3>
      <div id="scheduleItems" class="schedule-items">
        <p class="empty-message">スケジュールはありません</p>
      </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 設定ドロワー -->
  <div class="drawer" id="settingsDrawer">
    <div class="drawer-content">
      <div class="drawer-header">
        <h2>⚙️ 設定</h2>
        <button class="close-btn" data-drawer="settingsDrawer">×</button>
      </div>
      
      <div class="drawer-body">
        <section class="settings-voice-section">
          <h3>🎙️ 音声コマンド</h3>
          <p class="settings-voice-helper">音声で設定を変更できます。「通知をオフにして」「スマホアラートを70秒に」などと話しかけてください。</p>
          <div id="settingsVoiceControl"></div>
          <div id="settingsVoiceResult" class="settings-voice-result"></div>
        </section>

        <!-- アコーディオンメニュー -->
        <div class="accordion">
          <!-- 検知モデル設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>🤖 検知モデル設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="yoloEnabled" checked>
                  YOLO検知を有効にする
                </label>
              </div>
            </div>
          </div>

          <!-- スマホ検知設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>📱 スマホ検知設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label for="phoneThreshold">
                  アラートを鳴らすまでの時間 (秒)
                  <span class="description">スマホが検知され続けてからアラートを鳴らすまでの秒数</span>
                </label>
                <div class="slider-container">
                  <input type="range" id="phoneThreshold" min="1" max="600" value="10" step="1">
                  <span id="phoneThresholdValue" class="slider-value">10秒</span>
                </div>
              </div>

              <div class="form-group">
                <label>
                  <input type="checkbox" id="phoneAlertEnabled" checked>
                  スマホ検知アラートを有効にする
                </label>
              </div>

              <div class="form-group">
                <label for="phoneConfidence">
                  検知感度 (信頼度)
                  <span class="description">高いほど確実な検知のみ反応します</span>
                </label>
                <div class="slider-container">
                  <input type="range" id="phoneConfidence" min="0.1" max="0.9" value="0.5" step="0.1">
                  <span id="phoneConfidenceValue" class="slider-value">0.5</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 不在検知設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>👤 不在検知設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label for="absenceThreshold">
                  アラートを鳴らすまでの時間 (秒)
                  <span class="description">人が検知されなくなってからアラートを鳴らすまでの秒数</span>
                </label>
                <div class="slider-container">
                  <input type="range" id="absenceThreshold" min="1" max="600" value="30" step="1">
                  <span id="absenceThresholdValue" class="slider-value">30秒</span>
                </div>
              </div>

              <div class="form-group">
                <label>
                  <input type="checkbox" id="absenceAlertEnabled" checked>
                  不在検知アラートを有効にする
                </label>
              </div>

              <div class="form-group">
                <label for="absenceConfidence">
                  検知感度 (信頼度)
                  <span class="description">高いほど確実な検知のみ反応します</span>
                </label>
                <div class="slider-container">
                  <input type="range" id="absenceConfidence" min="0.1" max="0.9" value="0.5" step="0.1">
                  <span id="absenceConfidenceValue" class="slider-value">0.5</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 検知対象設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>🎯 検知対象設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="setting-description">
                監視する物体のカテゴリーを選択してください
              </div>
              <div id="detectionClassesContainer" class="class-toggles">
                <!-- JavaScriptで動的に生成 -->
              </div>
            </div>
          </div>

          <!-- 音声設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>🔊 音声設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label for="voicevoxSpeaker">
                  VOICEVOX 話者
                  <span class="description">音声合成に使用する話者を選択</span>
                </label>
                <select id="voicevoxSpeaker" class="form-select">
                  <!-- JavaScriptで動的に生成 -->
                </select>
              </div>
            </div>
          </div>

          <!-- 通知設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>🔔 通知設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="soundEnabled" checked>
                  アラート音を有効にする
                </label>
              </div>

              <div class="form-group">
                <label>
                  <input type="checkbox" id="desktopNotification" checked>
                  デスクトップ通知を有効にする
                </label>
              </div>
            </div>
          </div>

          <!-- 表示設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>🖼️ 表示設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="showDetections" checked>
                  検出フレームを表示
                </label>
              </div>
            </div>
          </div>

          <!-- Slack レポート設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>📊 Slack レポート設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="slackReporterEnabled">
                  Slack 定期レポートを有効にする
                </label>
              </div>

              <div class="form-group">
                <label for="slackWebhookUrl">Slack Webhook URL</label>
                <input type="text" id="slackWebhookUrl" placeholder="https://hooks.slack.com/services/...">
                <span class="description">Incoming Webhook の URL を貼り付けてください</span>
              </div>

              <div class="form-group">
                <label for="slackScheduleTimes">送信時刻 (HH:MM, カンマ区切り)</label>
                <input type="text" id="slackScheduleTimes" placeholder="13:00,18:00">
                <span class="description">例: 09:00,13:00,18:00</span>
              </div>

              <div class="form-group">
                <label for="slackTimezone">タイムゾーン</label>
                <input type="text" id="slackTimezone" placeholder="Asia/Tokyo">
                <span class="description">空欄のままならシステムのタイムゾーンを使用します</span>
              </div>

              <div class="slack-action-group">
                <button type="button" id="slackSaveBtn" class="btn-primary">Slack設定を保存</button>
                <button type="button" id="slackSendNowBtn" class="btn-secondary">今すぐ送信</button>
              </div>

              <div id="slackReporterMessage" class="slack-message"></div>
            </div>
          </div>

          <!-- タイピング監視設定 -->
          <div class="accordion-item">
            <button class="accordion-header" type="button">
              <span>⌨️ タイピング監視設定</span>
              <span class="accordion-icon">▼</span>
            </button>
            <div class="accordion-content">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="typingMonitorEnabled">
                  タイピング監視を有効にする
                </label>
              </div>

              <div class="form-group typing-settings-actions">
                <button type="button" id="typingMonitorPauseSettingsBtn" class="btn-secondary">休止 / 再開</button>
                <span id="typingMonitorSettingsStatus" class="typing-settings-status">状態取得中...</span>
              </div>

              <div id="typingMonitorSettingsMessage" class="slack-message"></div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button id="saveSettingsBtn" class="btn-primary">設定を保存</button>
          <button id="resetSettingsBtn" class="btn-secondary">デフォルトに戻す</button>
        </div>

        <div id="saveMessage" class="save-message"></div>
      </div>
    </div>
  </div>

  <!-- ログドロワー -->
  <div class="drawer" id="logsDrawer">
    <div class="drawer-content">
      <div class="drawer-header">
        <h2>📋 検知ログ</h2>
        <button class="close-btn" data-drawer="logsDrawer">×</button>
      </div>

      <div class="drawer-body">
        <div id="logContainer" class="log-container">
          <p class="empty-message">ログはありません</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 検知ダッシュボードダイアログ -->
  <div class="modal" id="dashboardModal">
    <div class="modal-backdrop" data-modal="dashboardModal"></div>
    <div class="modal-content">
      <div class="drawer-header">
        <h2>📊 検知ダッシュボード</h2>
        <div class="header-actions">
          <button id="dashboardRefreshBtn" class="btn-secondary btn-compact">最新を取得</button>
          <button class="close-btn" data-modal="dashboardModal">×</button>
        </div>
      </div>

      <div class="dashboard-body">
        <section class="dashboard-section filters">
          <div class="filter-group">
            <label for="dashboardRange">期間</label>
            <select id="dashboardRange">
              <option value="24h"selected>直近24時間</option>
              <option value="7d">直近7日</option>
              <option value="30d">直近30日</option>
              <option value="custom">カスタム</option>
            </select>
          </div>
          <div class="filter-group" id="dashboardCustomRange" style="display: none;">
            <label>開始</label>
            <input type="datetime-local" id="dashboardStart">
            <label>終了</label>
            <input type="datetime-local" id="dashboardEnd">
          </div>
          <div class="filter-group">
            <label for="dashboardGranularity">集計単位</label>
            <select id="dashboardGranularity">
              <option value="day">日別</option>
              <option value="hour" selected>時間別</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="dashboardTypeFilter">種別</label>
            <select id="dashboardTypeFilter">
              <option value="all" selected>すべて</option>
              <option value="phone">スマホ検知</option>
              <option value="absence">不在検知</option>
              <option value="alerts">アラートのみ</option>
              <option value="typing">タイピング</option>
            </select>
          </div>
        </section>

        <section class="dashboard-section kpi" id="dashboardKpis">
          <!-- JS で動的に生成 -->
        </section>

        <section class="dashboard-section slack-report" id="dashboardSlackSection">
          <div class="section-header">
            <h3>Slack レポート状況</h3>
          </div>
          <div class="slack-report-body">
            <p id="dashboardSlackSummary" class="slack-summary">Slack レポートは未設定です。</p>
            <div class="slack-upcoming" id="dashboardUpcomingSchedules">
              <div class="slack-upcoming-header">
                <span class="label">直近の予定</span>
                <span class="range">24時間以内</span>
              </div>
              <ul id="dashboardUpcomingSchedulesList" class="slack-upcoming-list">
                <li class="empty">スケジュールを読み込み中...</li>
              </ul>
            </div>
            <ul id="dashboardSlackHistory" class="slack-history-list">
              <li class="empty">履歴がありません</li>
            </ul>
          </div>
        </section>

        <section class="dashboard-section typing-activity">
          <div class="section-header">
            <h3>タイピングアクティビティ</h3>
            <div class="section-actions">
              <button id="typingStatsRefreshBtn" class="btn-secondary btn-compact">統計更新</button>
            </div>
          </div>
          <p id="typingMonitorStatus" class="typing-status">タイピング監視は無効です。</p>
          <div class="table-wrapper">
            <table id="dashboardTypingTable">
              <thead>
                <tr>
                  <th>開始</th>
                  <th>終了</th>
                  <th>キー入力数</th>
                  <th>最長連続入力</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty">
                  <td colspan="4">データを読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="dashboard-section system-events">
          <div class="section-header">
            <h3>システムイベント</h3>
            <button id="systemEventsRefreshBtn" class="btn-secondary btn-compact">最新を更新</button>
          </div>
          <div class="table-wrapper">
            <table id="dashboardSystemEventsTable">
              <thead>
                <tr>
                  <th>発生時刻</th>
                  <th>イベント</th>
                  <th>メタ情報</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty">
                  <td colspan="3">データを読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="dashboard-section chart">
          <div class="section-header">
            <h3>検知トレンド</h3>
          </div>
          <div style="position: relative; height: 280px;">
            <canvas id="dashboardTrendChart"></canvas>
          </div>
        </section>

        <section class="dashboard-section app-usage">
          <div class="section-header">
            <h3>前面アプリ滞在時間 (トップ10)</h3>
          </div>
          <div class="table-wrapper">
            <table id="dashboardAppUsageTable">
              <thead>
                <tr>
                  <th>アプリ</th>
                  <th>滞在時間</th>
                  <th>セッション数</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty">
                  <td colspan="3">データを読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="dashboard-section chrome-usage">
          <div class="section-header">
            <h3>Chromeのみの滞在時間 (トップ10)</h3>
          </div>
          <div class="table-wrapper">
            <table id="dashboardChromeUsageTable">
              <thead>
                <tr>
                  <th>ドメイン / タイトル</th>
                  <th>滞在時間</th>
                  <th>セッション数</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty">
                  <td colspan="3">データを読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section class="dashboard-section recent-logs">
          <div class="section-header">
            <h3>最新ログ</h3>
            <button id="dashboardExportCsvBtn" class="btn-secondary btn-compact">CSVエクスポート</button>
          </div>
          <div class="table-wrapper">
            <table id="dashboardLogTable">
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>種別</th>
                  <th>継続時間</th>
                  <th>詳細</th>
                </tr>
              </thead>
              <tbody>
                <tr class="empty">
                  <td colspan="4">ログを読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- チャットドロワー -->
  <div class="drawer" id="chatDrawer">
    <div class="drawer-content chat-drawer">
      <div class="drawer-header">
        <h2>🗣️ 音声チャット</h2>
        <button class="close-btn" data-drawer="chatDrawer">×</button>
      </div>
      <div class="drawer-body chat-body">
        <div class="chat-history" id="chatHistory"></div>
        <div class="chat-actions">
          <div id="chatVoiceControl"></div>
          <div id="chatStreamingText" class="chat-streaming"></div>
          <button id="chatClearHistoryBtn" class="btn-secondary btn-compact">履歴をクリア</button>
        </div>
      </div>
    </div>
  </div>


  <script src="../../node_modules/chart.js/dist/chart.umd.js"></script>
  <script type="module" src="../constants/voicevox-speakers.js"></script>
  <script type="module" src="../constants/yolo-classes.js"></script>
  <script type="module" src="../renderer/schedule.js"></script>
  <script type="module" src="../renderer/settings.js"></script>
  <script type="module" src="../renderer/monitor.js"></script>
  <script type="module" src="../renderer/dashboard.js"></script>
  <script type="module" src="../renderer/chat.js"></script>
  <script type="module" src="../renderer/app.js"></script>
</body>
</html>
